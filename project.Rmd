---
title: "DMII"
author: "Ana Catarina Monteiro, Artur Ferreira, Lucas Parada"
date: "4/25/2020"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r 1, echo=FALSE}
#libraries  
library(dplyr)
library(ggplot2)
library(gridExtra)
```


```{r 2}
movies <- read.csv('data/movies.csv')
profiles <- read.csv('data/profiles.csv')
#ratings <- read.csv('data/ratings.csv')  
```

Vamos observar as variáveis relevantes da tabela profiles

```{r 3}
profiles$gender <- as.factor(profiles$gender)
summary(profiles)
```

Podemos tirar três conclusões no que toca à idade:
  Os géneros são bastante equilibrados
  Grande parte dos utilizadores usa regularmente o serviço
  As idades correspondem em grande parte a uma faixa mais jovem. 
No entanto existem idades impróvaveis.
Portanto vamos resolver isso ao categorizar a variável "age", sendo que as categorias são:
12-17 "Adolescente"
18-64 "Adulto"
65-90 "Idosos"
\>90 ou NA "Desconhecido"

```{r 4}

profiles['agegroup'] <- profiles['age'] %>% mutate(age = 
                                              ifelse(is.na(age) , "Desconhecido",
                                              ifelse(age >= 10 & age < 18, 'Adolescente',
                                                     ifelse(age >= 18 & age < 35, 'Jovem Adulto',
                                                        ifelse(age >= 35 & age < 65, 'Adulto',
                                                            ifelse(age >= 65 & age <= 90, 'Idoso', 
                                                              "Desconhecido"))))))
                                                              
                                                              
age_raw <- data.frame(
  name = c("Adolescente","Adulto", "Desconhecido", "Idoso", "Jovem Adulto"), 
  value = profiles['agegroup'] %>% count(agegroup))

age_raw_plot = ggplot(age_raw, aes(x=name, y=value.n)) + 
  geom_bar(stat = "identity" ,
           fill = c("#33cc33", "#3399ff","#4d4d4d", "#6600ff","#6600ff")) + 
  labs(title="Figura 2: Utilizadores por faixa etária",
       x="Sexo", y="Nº de Utilizadores")


# Create data
gender_raw <- data.frame(
  name = c("Desconhecido","Feminino", "Masculino"), 
  value = profiles['gender'] %>% count(gender))

gender_raw_plot = ggplot(gender_raw, aes(x=name, y=value.n)) + 
  geom_bar(stat = "identity" ,
           fill = c("#4d4d4d", "#ff1ac6", "#0066ff")) + 
  labs(title="Figura 2: Utilizadores por género",
       x="Sexo", y="Nº de Utilizadores")
```

A tabela ratings

```{r 5, echo=TRUE}
summary(ratings)
```

Podemos ver que grande parte das classificações são "acima da média", isto é são positivas. 
Algo que é bom visto que, como o objectivo do projecto é recomendar filmes, apenas esses ratings iriam ser contabilizados.


```{r save_ratings}
# Create data
ratings['rating'] = floor(ratings$rating)
ratings_raw <- data.frame(
  name = c(0,1,2,3,4,5), value = ratings %>% count(rating)
  )
# Barplot
ratings_raw_plot <- ggplot(ratings_raw, aes(x=name, y=value.n)) + 
  geom_bar(stat = "identity" ,
           fill = c( "#fefe01", "#bffe01", "#80fe01","#fefe01", "#bffe01", "#80fe01")) + 
  theme(legend.position="none") +
    labs(
    title="Figura 1: Classificações de filmes",
       x="Rating",
       y="Nº of ratings")
```


```{r tacalado}
# Preliminary Analisys

print(paste("Existem ",
            length(movies$movieid),
            "filmes no dataset",
            sep=" "))

print(paste("Existem",
            length(unique(ratings$movieid)),
            "filmes com classifição",
            sep=" "))

print(paste("Portanto podemos retirar",
            length(movies$movieid) - length(unique(ratings$movieid)),
            sep=" "))

relevant <- unique(ratings$movieid)
movies <- movies[match(movies$movieid, relevant, nomatch=0),] 

```



Não queremos apenas filmes classificados,
mas também com boas classificações,
portanto vamos filtrar todos os ratings com
rating >= 3.
Não apenas isso, mas também queremos que o filme tenha
sido classificado por várias pessoas. Portanto,
vamos filtrar todos os filmes que têm pelo menos 30 classificações

```{r 6}
ratings <- filter(ratings, rating >= 3)
positive <- ratings %>% count(movieid)

summary(positive)

positive <- filter(positive, n >= 50)
ratings <- filter(ratings, movieid %in% positive$movieid)
movies <- filter(movies, movieid %in% positive$movieid)


# Create data
ratings_pro <- data.frame(
  name = c(3,4,5), value = ratings %>% count(rating)
  )
# Barplot
ratings_pro_plot <- ggplot(ratings_pro, aes(x=factor(name), y=value.n)) + 
  geom_bar(stat = "identity" ,
           fill = c( "#fefe01", "#bffe01", "#80fe01")) + 
  theme(legend.position="none") +
    labs(
    title="Figura 1: Ratings de filmes com mais de 10 ratings \"positivos\"",
       x="Rating",
       y="Nº of ratings")
```



```{r 7}


```


```{r 8}

users_prof <- unique(profiles$userid)
c_users_prof <- length(users_prof)
# Number of total users
print(c_users_prof)


users_rat <- unique(ratings$userid)
c_users_rat <- length(users_rat)
# Number of users that have rated a movie
print(c_users_rat)


# Number of useless users
print(c_users_prof - c_users_rat)

profiles <- filter(profiles, userid %in% users_rat)

```


```{r 9}

gender_pro <- data.frame(
  name = c("Desconhecido","Feminino", "Masculino"), 
  value = profiles['gender'] %>% count(gender))

gender_pro_plot = ggplot(gender_pro, aes(x=name, y=value.n)) + 
  geom_bar(stat = "identity" ,
           fill = c("#4d4d4d", "#ff1ac6", "#0066ff")) + 
  labs(title="Figura 2: Utilizadores que já classificaram um filme por género",
       x="Sexo", y="Nº de Utilizadores") 

grid.arrange(gender_raw_plot, gender_pro_plot, ncol=2)
```


```{r 10}

age_pro <- data.frame(
  name = c("Adolescente","Adulto", "Desconhecido", "Idoso", "Jovem Adulto"), 
  value = profiles['agegroup'] %>% count(agegroup))

age_pro_plot = ggplot(age_pro, aes(x=name, y=value.n)) + 
  geom_bar(stat = "identity" ,
           fill = c("#33cc33", "#3399ff","#4d4d4d", "#6600ff", "#6600ff")) + 
  labs(title="Figura 2: Utilizadores por género",
       x="Sexo", y="Nº de Utilizadores")

grid.arrange(age_raw_plot, age_pro_plot, ncol=2)


# Diferença de genero de quem votou
ggplot(profiles, aes(agegroup)) + 
     geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  + 
     scale_y_continuous(labels=scales::percent) +
     ylab("relative frequencies") + facet_grid(~gender)

```
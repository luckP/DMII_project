---
title: "DMII"
author: "Ana Catarina Monteiro, Artur Ferreira, Lucas Parada"
date: "4/25/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r 1, echo=FALSE}
#libraries  
library(dplyr)
library(ggplot2)
library(gridExtra)
library(recommenderlab)
library(scales)
library(caTools)
setwd("DMII_project")
```


```{r 2}
movies <- read.csv('data/movies.csv')
profiles <- read.csv('data/profiles.csv')
#ratings <- read.csv('data/ratings.csv') 
#ratings2 = ratings
ratings <- ratings2
```

```{r}
print(names(movies))
print(names(profiles))
print(names(ratings))
```

Transformar as datas para um object Date
```{r}
ratings['date'] <- as.Date(ratings$date)
profiles["memberfor"] <- as.Date(profiles$memberfor)
```

Summary de profiles e ratings
```{r}
print(summary(profiles))
print(summary(ratings))
```


De acordo com a Wikipédia, o Flixster foi fundado em 1 de Junho 2006.
Vamos apenas considerar que os ratings válidos são depois aqueles que foram efetuados no dia ou após o mesmo.
Visto que existem utilizadores com a data de registo inicial abaixo da data de fundação, vamos usar a primeira data de classificação de cada utilizador para, caso o atributo memberfor for menos que essa data então trocamos.
```{r}

ratings <- filter(ratings, date >= "2006-01-20")

first_rating <- ratings %>% group_by(userid) %>% slice(which.min(date))
first_rating <- first_rating %>% mutate(first_rating_date = date)
first_rating = subset(first_rating, select= -c(movieid,rating, date))

# tambem remove utilizadores sem rating
profiles = merge(profiles, first_rating, by="userid")

profiles = profiles %>% mutate(memberfor = if_else(as.Date(memberfor)>as.Date(first_rating_date), 
                                                   as.Date(first_rating_date), as.Date(memberfor)))
```


GRAFICO para as idades
para o genero tambem
Se a idade for nula ou o género não existir então removemos assim como utilizadores com idade superior a 70
Criamos uma nova coluna onde a idade é de 5 em 5 anos. 
```{r}
profiles <- filter(profiles, !is.na(age) & gender != "")
profiles$gender <- as.factor(profiles$gender)

profiles['agegroup'] <- profiles['age'] %>% mutate(age = as.integer(age/5)*5)
profiles$agegroup[is.na(profiles$agegroup) | profiles$agegroup > 70] <- 0
profiles <- filter(profiles, agegroup != 0)

```


Com os utilizadores filtrados, filtramos tambem os ratings para contem apenas esses utilizadores
```{r}
users <- select(profiles, c("userid"))

#filter ratings to have valid users (function filter com %in% demora muito)
ratings <- merge(ratings, users, by="userid")

```


```{r}
#grafico de quantidade de ratings por filme
#grafico de quantidade de ratings por utilizador

```

Arranjar desculpa para filtrar

```{r}

ratings <- ratings %>% group_by(movieid) %>% filter(n() >= 10 & n() <= 3000)
ratings <- ratings %>% group_by(userid) %>% filter(n() >= 10 & n() <= 15)

valid_users <- as.data.frame(unique(ratings$userid))
colnames(valid_users)[1] <- "userid"
valid_movies <- as.data.frame(unique(ratings$movieid))
colnames(valid_movies)[1] <- "movieid"
profiles <- merge(profiles, valid_users, by="userid")
movies <- merge(movies, valid_movies, by="movieid")


print(nrow(valid_users))
print(nrow(valid_movies))
```


```{r}
dat <- table(ratings$userid, ratings$movieid)
dm <- dist(dat)
```



```{r 4}

profiles['agegroup'] <- profiles['age'] %>% mutate(age = as.integer(age/5)*5)
profiles$agegroup[is.na(profiles$agegroup) | profiles$agegroup > 70] <- 0
profiles <- filter(profiles, agegroup != 0)
                                                              

age_raw_plot = ggplot(profiles, aes(agegroup)) + 
           geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup))) +
  scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 1: Utilizadores por idade", x="Sexo", y="% de Utilizadores")


gender_raw_plot = ggplot(profiles, aes(gender)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(gender))) +
  scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 2: Utilizadores por género",x="Sexo", y="% de Utilizadores")


age_sex_raw_plot = ggplot(profiles, aes(agegroup)) + 
     geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  + 
     scale_y_continuous(labels=scales::percent) +
     labs(title="Figura 3: Idade dos utilizadores por género", x="Idade", y="% de Utilizadores") + 
     facet_grid(~gender)
```






```{r}
#set.seed(7)
#mask = sample.split(profiles$gender, SplitRatio=0.7)
#profiles_train = profiles[ mask,]
#profiles_test  = profiles[!mask,]
# u_ratings_count <- ratings %>% count(userid)
# u_ratings_count <- u_ratings_count %>% mutate(test = n>5 & n<=10)
# users_train = filter(u_ratings_count, test==FALSE)$userid
# users_test = filter(u_ratings_count, test==TRUE)$userid
train <- filter(ratings, date < "2009-01-01")
test <- filter(ratings, date >= "2009-01-01")

#rm(mask)

```




Não queremos apenas filmes classificados,
mas também com boas classificações,
portanto vamos filtrar todos os ratings com
rating >= 3.
Não apenas isso, mas também queremos que o filme tenha
sido classificado por várias pessoas. Portanto,
vamos filtrar todos os filmes que têm pelo menos 30 classificações

```{r 6}
valid_movies <- ratings %>% count(movieid)

valid_movies <- filter(valid_movies, n >= 100)
ratings <- filter(ratings, movieid %in% valid_movies$movieid)
movies <- filter(movies, movieid %in% ratings$movieid)

ratings_pro_plot <- ggplot(ratings, aes(rating)) +
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(rating)))  +
  scale_y_continuous(labels=scales::percent) +
  theme(legend.position="none") +
  labs(
    title="Figura 1: Ratings de filmes com mais de 50 ratings \"positivos\"", x="Rating", y="Nº of ratings")

rm(valid_movies)
#ratings_pro_plot

train <- filter(ratings, date < "2009-01-01")
test <- filter(ratings, date >= "2009-01-01")

```


```{r 9}

gender_pro_plot = ggplot(profiles, aes(gender)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(gender)))  + 
     scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 2: Utilizadores que já classificaram um filme por género",
       x="Sexo", y="Nº de Utilizadores") 

grid.arrange(gender_raw_plot, gender_pro_plot, ncol=2)
```


```{r 10}

age_pro_plot = ggplot(profiles, aes(agegroup)) + 
 geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  + 
     scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 2: Utilizadores por género",
       x="Sexo", y="Nº de Utilizadores")

grid.arrange(age_raw_plot, age_pro_plot, ncol=2)
```

```{r 11}
# Diferença de genero de quem votou
ggplot(profiles, aes(agegroup)) + 
     geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  + 
     scale_y_continuous(labels=scales::percent) +
     ylab("relative frequencies") + facet_grid(~gender)

```


```{r}
bm <- as(as.data.frame(ratings), "binaryRatingMatrix")
image(bm)
```


```{r}
es <- evaluationScheme(bm, method="split", train=0.80, given=5)

ar_params <- list(supp = 0.01, conf = 0.8, maxlen = 5)
ucf_params <- list(method = "cosine", nn=3)
icf_params <- list(method = "cosine", k=3)

models <- list(
  pop_model = list(name = "POPULAR"),
  ar_model = list(name = "AR", param = ar_params),
  ucf_model = list(name = "UBCF", parameter = ucf_params),
  icf_model = list(name = "IBCF", parameter = icf_params))

res <- evaluate(x = es, method = models, type="topNList", n = c(1,2,5))

```




```{r}
rm <- as(as.data.frame(ratings), "realRatingMatrix")

```



```{r}
image(as(as.data.frame(head(ratings,100)),"realRatingMatrix"))
```



```{r}
es <- evaluationScheme(rm, method="split", train=0.99, given=5)

ucf_params <- list(method = "cosine", nn=5)
icf_params <- list(method = "cosine", k=5)

models <- list(
  ucf_model = list(name = "UBCF", parameter = ucf_params),
  icf_model = list(name = "IBCF", parameter = icf_params))


res <- evaluate(x = es, method = models, type = "ratings", n = c(1,2,5))
```






















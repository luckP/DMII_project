---
title: "DMII"
author: "Ana Catarina Monteiro, Artur Ferreira, Lucas Parada"
date: "4/25/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r 1, echo=FALSE}
#libraries  
library(dplyr)
library(ggplot2)
library(gridExtra)
library(recommenderlab)

library(arules)
library(arulesViz)
```


```{r 2}
movies <- read.csv('data/movies.csv')
profiles <- read.csv('data/profiles.csv')
#ratings <- read.csv('data/ratings.csv') 
#ratings2 = ratings
ratings <- ratings2
```

Vamos observar as variáveis relevantes da tabela profiles

```{r 3}
profiles$gender[profiles$gender == ""] <- "Unknown"
profiles$gender <- as.factor(profiles$gender)


summary(profiles)
```

Podemos tirar três conclusões no que toca à idade:
  Os géneros são bastante equilibrados
  Grande parte dos utilizadores usa regularmente o serviço
  As idades correspondem em grande parte a uma faixa mais jovem. 
No entanto existem idades impróvaveis.
Portanto vamos resolver isso ao categorizar a variável "age", sendo que as categorias são de 5 em 5
Não apenas isso mas também iremos considerar que as idades acima do 3º quartil 
são desconhecidas, visto que há poucas

```{r 4}

profiles['agegroup'] <- profiles['age'] %>% mutate(age = as.integer(age/5)*5)
profiles$agegroup[is.na(profiles$agegroup) | profiles$agegroup > 70] <- 0
                                                              

age_raw_plot = ggplot(profiles, aes(agegroup)) + 
           geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup))) +
  scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 2: Utilizadores por faixa etária",
       x="Sexo", y="Nº de Utilizadores")


gender_raw_plot = ggplot(profiles, aes(gender)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(gender))) +
  scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 2: Utilizadores por género",
       x="Sexo", y="Nº de Utilizadores")


age_sex_raw_plot = ggplot(profiles, aes(agegroup)) + 
     geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  + 
     scale_y_continuous(labels=scales::percent) +
     ylab("relative frequencies") + facet_grid(~gender)
```

A tabela ratings

```{r 5, echo=TRUE}
summary(ratings)
```

Podemos ver que grande parte das classificações são "acima da média", isto é são positivas. 
Algo que é bom visto que, como o objectivo do projecto é recomendar filmes, apenas esses ratings iriam ser contabilizados.


```{r save_ratings}
# Create data
ratings['rating'] = floor(ratings$rating)

ratings_raw_plot <- ggplot(ratings, aes(rating)) + 
 geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(rating)))  + 
  scale_y_continuous(labels=scales::percent) +
    labs(
    title="Figura 1: Classificações de filmes",
       x="Rating",
       y="Nº of ratings")
```


```{r tacalado}
# Preliminary Analisys

# print(paste("Existem ",
#             length(movies$movieid),
#             "filmes no dataset",
#             sep=" "))
# 
# print(paste("Existem",
#             length(unique(ratings$movieid)),
#             "filmes com classifição",
#             sep=" "))
# 
# print(paste("Portanto podemos retirar",
#             length(movies$movieid) - length(unique(ratings$movieid)),
#             sep=" "))
# 
# relevant <- unique(ratings$movieid)
# movies <- filter(movies, movieid %in% relevant)

```



Não queremos apenas filmes classificados,
mas também com boas classificações,
portanto vamos filtrar todos os ratings com
rating >= 3.
Não apenas isso, mas também queremos que o filme tenha
sido classificado por várias pessoas. Portanto,
vamos filtrar todos os filmes que têm pelo menos 30 classificações

```{r 6}
ratings <- filter(ratings, rating >= 3)
positive <- ratings %>% count(movieid)

summary(positive)

positive <- filter(positive, n >= 50)
ratings <- filter(ratings, movieid %in% positive$movieid)
movies <- filter(movies, movieid %in% ratings$movieid)


ratings_pro_plot <- ggplot(ratings, aes(rating)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(rating)))  + 
  scale_y_continuous(labels=scales::percent) +
  theme(legend.position="none") +
    labs(
    title="Figura 1: Ratings de filmes com mais de 50 ratings \"positivos\"",
       x="Rating",
       y="Nº of ratings")
```


```{r 8}

users_prof <- unique(profiles$userid)
c_users_prof <- length(users_prof)
# Number of total users
print(c_users_prof)


users_rat <- unique(ratings$userid)
c_users_rat <- length(users_rat)
# Number of users that have rated a movie
print(c_users_rat)


# Number of useless users
print(c_users_prof - c_users_rat)

profiles <- filter(profiles, userid %in% users_rat)

```


```{r 9}

gender_pro_plot = ggplot(profiles, aes(gender)) + 
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(gender)))  + 
     scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 2: Utilizadores que já classificaram um filme por género",
       x="Sexo", y="Nº de Utilizadores") 

grid.arrange(gender_raw_plot, gender_pro_plot, ncol=2)
```


```{r 10}

age_pro_plot = ggplot(profiles, aes(agegroup)) + 
 geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  + 
     scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 2: Utilizadores por género",
       x="Sexo", y="Nº de Utilizadores")

grid.arrange(age_raw_plot, age_pro_plot, ncol=2)
```

```{r 11}
# Diferença de genero de quem votou
ggplot(profiles, aes(agegroup)) + 
     geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  + 
     scale_y_continuous(labels=scales::percent) +
     ylab("relative frequencies") + facet_grid(~gender)
```


```{r}
bm <- as(ratings,"binaryRatingMatrix")

```

```{r}
pop_model <- Recommender(bm, "POPULAR")
getModel(pop_model)

```



```{r}

# busca das classificações do userid 11
user_movies <- filter(ratings, userid == 1049494)$movieid
#alteramos o user para uma lista de strings
user_movies <- as.character(user)[21:26]

# converter para uma linha
activeuser <- matrix(0 , 1, ncol=length(unique(movies$movieid)), 
                     dimnames = list(" ",
                                     as.character(sort(unique(movies$movieid)))))

# mudar as classificaçoes para 1
activeuser[1, user_movies] <- 1
 
# mudar para binary...
aubm <- as(activeuser, 'binaryRatingMatrix')

#prever
#predict(pop_model, aubm, n=10)

#guardar
recs <- predict(pop_model, aubm, n=20)

#imprimir
getList(recs)
```

```{r}
getRatingMatrix(bm)

inspect(getRatingMatrix(bm))


```



```{r}

param = list(supp = 0.03, conf = 0.7, maxlen = 10)

ar_model <- Recommender(bm, "AR", param)


```

```{r}
# busca das classificações do userid 11
user_movies <- filter(ratings, userid == 103006)$movieid

user_movies <- as.character(user)[15:25]

# converter para uma linha
activeuser <- matrix(0 , 1, ncol=length(unique(movies$movieid)), 
                     dimnames = list(" ",
                                     as.character(sort(unique(movies$movieid)))))

# mudar as classificaçoes para 1
activeuser[1, user_movies] <- 1
 
# mudar para binary...
aubm <- as(activeuser, 'binaryRatingMatrix')

#prever
#predict(ar_model, aubm, n=10)

#guardar
recs <- predict(ar_model, aubm, n=20)

#imprimir
getList(recs)


getModel(ar_model)



```


```{r}
rules <- getModel(ar_model)$rule_base
inspect(rules)

```

























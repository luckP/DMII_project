---
title: "DMII"
author: "Ana Catarina Monteiro, Artur Ferreira, Lucas Parada"
date: "4/25/2020"
output:
  html_document:
    theme: flatly
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(ggplot2)
library(gridExtra)
library(recommenderlab)
library(scales)
library(caTools)
set.seed(7) # for reproducibility
#setwd("DMII_project")
```

# Introdução


# Exploração e processamento dos dados
Falar do processamento que foi feito em python

```{r echo=FALSE}
movies <- read.csv('data/movies.csv')
profiles <- read.csv('data/profiles.csv')
#ratings <- read.csv('data/ratings.csv') 
#ratings2 <- ratings
ratings <- ratings2
```


As colunas das tabelas Movies, Profiles e Ratings são as seguintes, respetivamente:
```{r echo=FALSE}
print(names(movies))
print(names(profiles))
print(names(ratings))
```


Temos algumas colunas referentes a datas, no entanto, encontram-se em *character*. Para vermos os detalhes destas colunas na função summary vamos transformá-las em Date.
```{r echo=FALSE}
ratings['date'] <- as.Date(ratings$date)
profiles["memberfor"] <- as.Date(profiles$memberfor)
```

Summary de movies, profiles e ratings
```{r echo=FALSE}
print(summary(movies))
print(summary(profiles))
print(summary(ratings))
```


De acordo com a Wikipédia, o [Flixster](https://en.wikipedia.org/wiki/Flixster) foi fundado em 20 de Janeiro 2006.
Como vimos no summary acima, nem todas as datas estão de acordo com isto. 
Vamos apenas considerar que os ratings válidos são aqueles que foram efetuados no dia ou após o mesmo.
Visto que existem utilizadores com a data de registo inicial abaixo da data de fundação, vamos usar a primeira data de classificação de cada utilizador para, caso o atributo memberfor for menos que essa data então trocamos.
```{r echo=FALSE}
ratings <- filter(ratings, date >= "2006-01-20")

first_rating <- ratings %>% group_by(userid) %>% slice(which.min(date))
first_rating <- first_rating %>% mutate(first_rating_date = date)
first_rating = subset(first_rating, select= -c(movieid,rating, date))

# tambem remove utilizadores sem rating
profiles = merge(profiles, first_rating, by="userid")

#profiles = profiles %>% mutate(test= memberfor > first_rating_date ,memberfor = if_else(as.Date(memberfor) > as.Date(first_rating_date), 
#                                                   first_rating_date, memberfor))
profiles = profiles %>% mutate(memberfor = if_else(is.na(memberfor) | pmin(memberfor,first_rating_date) < "2006-01-20", 
                                                    first_rating_date, memberfor))
```

Com isto as datas de Profiles e Ratings ficam:
```{r echo=FALSE}
summary(profiles$memberfor)
summary(ratings$date)
```


De forma a tornar mais fácil a visualição das idades, agrupamos as idades de cada utilizador de 5 em 5 anos.
```{r echo=FALSE, warning=FALSE}
profiles['agegroup'] <- profiles['age'] %>% mutate(age = as.integer(age/5)*5)

ggplot(profiles, aes(agegroup)) +
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  +
  guides(fill=guide_legend(title="Idade")) +
  scale_y_continuous(labels=scales::percent) +
  labs(title="Idade dos utilizadores por género", x="Idade", y="% de Utilizadores") +
  facet_grid(~gender)
```
Como existem poucos utilizadores sem género ou com a idade superior a 60, decidimos removê-los.
Também vamos ignorar os casos em que a idade é nula para posteriormente, pudermos fazer recomendações com base em contexto.


```{r echo=FALSE}

profiles <- filter(profiles, !is.na(age) & gender != "")
profiles$gender <- as.factor(profiles$gender)

profiles$agegroup[is.na(profiles$agegroup) | profiles$agegroup > 60] <- 0
profiles <- filter(profiles, agegroup != 0)

ggplot(profiles, aes(agegroup)) +
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  +
  guides(fill=guide_legend(title="Idade")) +
  scale_y_continuous(labels=scales::percent) +
  labs(title="Figura 2: Idade dos utilizadores por género (processado)", x="Idade", y="% de Utilizadores") +
  facet_grid(~gender)
```
Podemos ver que em geral, tratam-se de utilizadores do género feminino especialmente em faixas etárias mais baixas.


Com os utilizadores filtrados, filtramos tambem os ratings para contem apenas esses utilizadores
```{r echo=FALSE}
users <- select(profiles, c("userid"))

#filter ratings to have valid users (function filter com %in% demora muito)
ratings <- merge(ratings, users, by="userid")

```

## Ratings por filme
Descobrimos que existe uma grande desproporcionalidade na quantidade de ratings que cada filme tem:
```{r echo=FALSE}
summary(ratings %>% count(movieid))
```
Existem filmes com apenas uma classificação e no máximo temos 34.791 classificações.
Devido a descrepância dos dados, criámos gráfico que mostra a quantidade de filmes com N ratings em escala exponencial.
```{r echo=FALSE}
#grafico de quantidade de ratings por filme
#grafico de quantidade de ratings por utilizador
movie_count <- as.data.frame(ratings$movieid) 
colnames(movie_count)[1] <- "movieid"
movie_count <- movie_count %>% count(movieid) %>% count(n)


#filter(num_users_by_num_ratings, n < 2000 & n > 1)
ggplot(movie_count, aes(n, nn)) +
    geom_line() +
    labs(y="Nº filmes",
         x="Nº de ratings",
         title="Nº de filmes com X ratings") + 
  scale_y_continuous(trans = log10_trans(),
                     breaks = trans_breaks("log2", function(x) 2^x),
                     labels = trans_format("log2", math_format(2^.x))) +
  scale_x_continuous(trans = log10_trans(),
                     breaks = trans_breaks("log2", function(x) 2^x),
                     labels = trans_format("log2", math_format(2^.x)))

```
Decidimos então remover os filmes que têm menos de 10 ratings para garantir a relevância dos filme entre os utilizadores, isto é, um filme com poucas classificações tem pouca probabilidade de ser recomendado. Também removemos os que têm mais que 1024 avaliações para poder fazer mais recomendações inesperadas pelos utilizadores.

Existe também uma grande diferença na quantidade de classificações feitas por utilizador
```{r echo=FALSE}
summary(ratings %>% count(userid))
```
Existem muitos utilizadores com milhares de avaliações. 
Tal como em cima, geramos um gráfico em escala exponencial que mostra a quantidade de utilizadores com N ratings.

```{r echo=FALSE}
ratings <- ratings %>% group_by(movieid) %>% filter(n() >= 10 & n() <= 1024)

movie_count <- as.data.frame(ratings$userid) 
colnames(movie_count)[1] <- "userid"
movie_count <- movie_count %>% count(userid) %>% count(n)


#filter(num_users_by_num_ratings, n < 2000 & n > 1)
ggplot(movie_count, aes(n, nn)) +
    geom_line() +
    labs(y="Nº users",
         x="Nº de ratings",
         title="Nº de users com X ratings") + 
  scale_y_continuous(trans = log10_trans(),
                     breaks = trans_breaks("log2", function(x) 2^x),
                     labels = trans_format("log2", math_format(2^.x))) +
  scale_x_continuous(trans = log10_trans(),
                     breaks = trans_breaks("log2", function(x) 2^x),
                     labels = trans_format("log2", math_format(2^.x)))

ratings <- ratings %>% group_by(userid) %>% filter(n() >= 10 & n() <= 32)
```
Como queremos gerar recomendações a um grupo que vai tirar melhor proveito delas, retir  



```{r echo=FALSE}

valid_users <- as.data.frame(unique(ratings$userid))
colnames(valid_users)[1] <- "userid"
valid_movies <- as.data.frame(unique(ratings$movieid))
colnames(valid_movies)[1] <- "movieid"
profiles <- merge(profiles, valid_users, by="userid")
movies <- merge(movies, valid_movies, by="movieid")


print(paste("Nº de utilizadores",nrow(valid_users)))
print(paste("Nº de filmes",nrow(valid_movies)))

ggplot(profiles, aes(agegroup)) +
  geom_bar(aes(y = (..count..)/sum(..count..), fill = factor(agegroup)))  +
  guides(fill=guide_legend(title="Idade")) +
  scale_y_continuous(labels=scales::percent) +
  labs(title="Idade dos utilizadores por género (processado)", x="Idade", y="% de Utilizadores") +
  facet_grid(~gender)
```





# Modelos


```{r eval=FALSE, include=FALSE}
eval_binary_func <- function(mat, train, given, nn) {
  es <- evaluationScheme(mat, method="split", train=train, given=given)

  ar_params <- list(supp = 0.01, conf = 0.8, maxlen = 5)
  ucf_params <- list(method = "cosine", nn=nn)
  icf_params <- list(method = "cosine", k=nn)

  models <- list(
    pop_model = list(name = "POPULAR"),
    ar_model = list(name = "AR", param = ar_params),
    ucf_model = list(name = "UBCF", parameter = ucf_params),
    icf_model = list(name = "IBCF", parameter = icf_params))

  res <- evaluate(x = es, method = models, type="topNList", n = c(1,2,5))
  return(res)
}

eval_real_func <- function(mat, train, given, nn) {
  es <- evaluationScheme(mat, method="split", train=train, given=given, goodRating = 3.0)

  ucf_params <- list(method = "cosine", nn=nn)
  icf_params <- list(method = "cosine", k=nn)

  models <- list(
    ucf_model = list(name = "UBCF", parameter = ucf_params),
    icf_model = list(name = "IBCF", parameter = icf_params))

  res <- evaluate(x = es, method = models, type="topNList", n = c(1,2,5))
  return(res)
}
```

## Sem contexto

```{r eval=FALSE, include=FALSE}
bm <- as(as.data.frame(ratings), "binaryRatingMatrix")

image(bm)
```


```{r eval=FALSE, include=FALSE}
res <- eval_binary_func(bm, 0.80, 5, 5)
print(avg(res))
```

avaliar


```{r eval=FALSE, include=FALSE}
rm <- as(as.data.frame(ratings), "realRatingMatrix")

image(rm[1:100,2000:2100], cuts=8, colorkey=T, col=topo.colors(10))
```



```{r eval=FALSE, include=FALSE}
res <- eval_real_func(bm, 0.80, 5, 5)
print(avg(res))

```

avaliar



## Com contexto
```{r eval=FALSE, include=FALSE}
users <- filter(profiles, agegroup == 15 )$userid
bm <- as(as.data.frame(filter(ratings, userid %in% users)), "binaryRatingMatrix")

res <- eval_binary_func(bm, 0.8, 5, 5)
print(avg(res))

```


```{r eval=FALSE, include=FALSE}
users <- filter(profiles, agegroup == 15 & gender == "Female")$userid
bm <- as(as.data.frame(filter(ratings, userid %in% users)), "binaryRatingMatrix")

res <- eval_binary_func(bm, 0.8, 5, 5)
print(avg(res))

```


```{r eval=FALSE, include=FALSE}
users <- filter(profiles, agegroup == 15 & gender == "Male")$userid
bm <- as(as.data.frame(filter(ratings, userid %in% users)), "binaryRatingMatrix")

res <- eval_binary_func(bm, 0.8, 5, 5)
print(avg(res))

```














